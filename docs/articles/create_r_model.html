<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>More Flexible Model Run â€¢ hanojoel</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="More Flexible Model Run">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">hanojoel</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/run_model.html">Simplest Model Run</a>
    </li>
    <li>
      <a href="../articles/create_r_model.html">More Flexible Model Run</a>
    </li>
    <li>
      <a href="../articles/intro_to_nets.html">Adding ITNs and IRS</a>
    </li>
    <li class="divider">
    <li>
      <a href="../CONTRIBUTING.html">Contributing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/hanojoel">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>More Flexible Model Run</h1>
                        <h4 class="author">H. Juliette T. Unwin</h4>
            
            <h4 class="date">2019-05-29</h4>
      
      
      <div class="hidden name"><code>create_r_model.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>Within this package there are 2 ways to run the deterministic base model. This vignette focuses on the <code>create_r_model</code> function, which gives the user maximum control of the input parameters. The second,<br><code>run_model</code> function, solves the base model. For more infomation about the <code>run_model</code> function see this <a href="https://mrc-ide.github.io/hanojoel/articles/run_model.html">vignette</a>.</p>
</div>
<div id="default-use-of-function" class="section level2">
<h2 class="hasAnchor">
<a href="#default-use-of-function" class="anchor"></a>Default use of function</h2>
<p>The <code>create_r_model</code> function creates the odin deterministic malaria model in R. It has the following default arguments:</p>
<ol style="list-style-type: decimal">
<li>Odin model path - <code>odin_model_path = system.file("extdata/odin_model.R", package = "hanojoel"</code>
</li>
<li>The number of heterogeneity brakets - <code>het_brackets = 5</code>
</li>
<li>The vector of age compartments - <code>age = c(0,0.25,0.5,0.75,1,1.25,1.5,1.75,2,3.5,5,7.5,10,15,20,30,40,50,60,70,80)</code>
</li>
<li>The initial EIR - <code>init_EIR = 10</code>
</li>
<li>The percentage of the population that gets treated - <code>init_ft = 0.4</code>
</li>
<li>The country - <code>country = NULL</code>
</li>
<li>The admin 2 unit - <code>admin2 = NULL</code>
</li>
</ol>
<p>The simplest example of using the function to plot the malaria prevelance for a country with no seasonablity (found by setting both the country and admin2 to NULL) is:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(hanojoel)

wh &lt;-<span class="st"> </span>hanojoel<span class="op">:::</span><span class="kw"><a href="../reference/create_r_model.html">create_r_model</a></span>()

<span class="co"># generates model functions with initial state data</span>
mod &lt;-<span class="st"> </span>wh<span class="op">$</span><span class="kw">generator</span>(<span class="dt">user=</span> wh<span class="op">$</span>state, <span class="dt">use_dde =</span> <span class="ot">TRUE</span>)

<span class="co"># Runs the model</span>
mod_run &lt;-<span class="st"> </span>mod<span class="op">$</span><span class="kw">run</span>(<span class="dt">t =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">365</span>)
out &lt;-<span class="st"> </span>mod<span class="op">$</span><span class="kw">transform_variables</span>(mod_run)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(out<span class="op">$</span>t,out<span class="op">$</span>prev, <span class="dt">main=</span> <span class="st">"Prevalance"</span>, <span class="dt">ylim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.22</span>, <span class="fl">0.24</span>), <span class="dt">type=</span><span class="st">'l'</span>)</code></pre></div>
<p><img src="create_r_model_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
</div>
<div id="providing-alternative-arguments" class="section level2">
<h2 class="hasAnchor">
<a href="#providing-alternative-arguments" class="anchor"></a>Providing alternative arguments</h2>
<p>It is posisble to change the default arguments for the <code>create_r_model</code> function as shown below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># create a vector of age categories</span>
init_age &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="dv">1</span>,<span class="fl">1.25</span>,<span class="fl">1.5</span>,<span class="fl">1.75</span>,<span class="dv">2</span>,<span class="fl">3.5</span>,<span class="dv">5</span>,<span class="fl">7.5</span>,<span class="dv">10</span>,<span class="dv">15</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">40</span>,<span class="dv">50</span>,<span class="dv">60</span>,<span class="dv">70</span>,<span class="dv">80</span>)

<span class="co"># provide a value of the annual EIR for this model run</span>
init_EIR &lt;-<span class="st"> </span><span class="dv">10</span>

<span class="co"># provide a string for the admin 2 unit that you want to use the seasonality profile for</span>
admin_str &lt;-<span class="st"> "Tororo"</span>

<span class="co"># provide the length of time (in days) that you want to run the model for</span>
time_period &lt;-<span class="st"> </span><span class="dv">365</span><span class="op">*</span><span class="dv">1</span>

<span class="co"># provide a value for the proportion of cases that are treated (referred to as ft in the paper)</span>
prop_treated &lt;-<span class="st"> </span><span class="fl">0.4</span>

<span class="co"># creates the odin model using the default odin model file</span>
wh &lt;-<span class="st"> </span>hanojoel<span class="op">:::</span><span class="kw"><a href="../reference/create_r_model.html">create_r_model</a></span>(<span class="dt">odin_model_path =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="st">"extdata/odin_model.R"</span>, <span class="dt">package =</span> <span class="st">"hanojoel"</span>),
                                <span class="dt">het_brackets =</span> <span class="dv">5</span>,
                                <span class="dt">age =</span> init_age,
                                <span class="dt">init_EIR =</span> init_EIR,
                                <span class="dt">init_ft =</span> prop_treated,
                                <span class="dt">country =</span> <span class="st">"Uganda"</span>,
                                <span class="dt">admin2 =</span> <span class="st">"Tororo"</span>)

<span class="co"># generates model functions with initial state data</span>
mod &lt;-<span class="st"> </span>wh<span class="op">$</span><span class="kw">generator</span>(<span class="dt">user=</span> wh<span class="op">$</span>state, <span class="dt">use_dde =</span> <span class="ot">TRUE</span>)

<span class="co"># Runs the model</span>
mod_run &lt;-<span class="st"> </span>mod<span class="op">$</span><span class="kw">run</span>(<span class="dt">t =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">365</span>)
out &lt;-<span class="st"> </span>mod<span class="op">$</span><span class="kw">transform_variables</span>(mod_run)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(out<span class="op">$</span>t,out<span class="op">$</span>prev, <span class="dt">main=</span><span class="st">"Prevalence"</span>, <span class="dt">type=</span><span class="st">'l'</span>)</code></pre></div>
<p><img src="create_r_model_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>It is also possible to change the odin model by editing the <code>odin_model_path</code>. If the model is built within the package, such as <code>odin_model_hrp2.R</code>, change the path to:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">odin_model_path =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="st">"extdata/odin_model_hrp2.R"</span>, <span class="dt">package =</span> <span class="st">"hanojoel"</span>)</code></pre></div>
<p>If the odin model is only held locally, change the model path to:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">odin_model_path =<span class="st"> "extdata/odin_model_hrp2.R"</span></code></pre></div>
</div>
<div id="adding-additional-optional-arguments" class="section level2">
<h2 class="hasAnchor">
<a href="#adding-additional-optional-arguments" class="anchor"></a>Adding additional optional arguments</h2>
<p>It may be necessary to provide extra optional arguments to the odin model. For example if you run the <code>odin_model_hrp2.R</code> model without any extra arguments it produces an error:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># creates the odin model using the default odin model file</span>
wh &lt;-<span class="st"> </span>hanojoel<span class="op">:::</span><span class="kw"><a href="../reference/create_r_model.html">create_r_model</a></span>(<span class="dt">odin_model_path =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="st">"extdata/odin_model_hrp2.R"</span>, 
                                                              <span class="dt">package =</span> <span class="st">"hanojoel"</span>))
mod &lt;-<span class="st"> </span>wh<span class="op">$</span><span class="kw">generator</span>(<span class="dt">user=</span> wh<span class="op">$</span>state, <span class="dt">use_dde =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; Error in self$set_user(user = user, unused_user_action = unused_user_action): Expected a value for 'hrp2_prop'</span></code></pre></div>
<p>This is because the required user argument <code>hrp2_prop</code> has not been provided. This is done as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># creates the odin model using the default odin model file</span>
wh &lt;-<span class="st"> </span>hanojoel<span class="op">:::</span><span class="kw"><a href="../reference/create_r_model.html">create_r_model</a></span>(<span class="dt">odin_model_path =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="st">"extdata/odin_model_hrp2.R"</span>, 
                                                              <span class="dt">package =</span> <span class="st">"hanojoel"</span>), 
                                <span class="dt">hrp2_prop =</span> <span class="fl">0.5</span>)
mod &lt;-<span class="st"> </span>wh<span class="op">$</span><span class="kw">generator</span>(<span class="dt">user=</span> wh<span class="op">$</span>state, <span class="dt">use_dde =</span> <span class="ot">TRUE</span>)</code></pre></div>
</div>
<div id="changing-seasonality-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#changing-seasonality-parameters" class="anchor"></a>Changing seasonality parameters</h2>
<p>It is possible to change the seasonality parameters by specifying a named admin unit or both an admin unit and country to the <code>hanojoel:::create_r_model()</code> function. The latter is better when the admin name is common. Fuzzy matching is used to match the provided arguments with the data set provided in the package. The data set can be loaded into your workspace as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">seasonality_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/load_file.html">load_file</a></span>(<span class="st">"admin_units_seasonal.rds"</span>)</code></pre></div>
</div>
<div id="adding-interventions" class="section level2">
<h2 class="hasAnchor">
<a href="#adding-interventions" class="anchor"></a>Adding interventions</h2>
<p>It is possible to vary the number of interventions considered in the model.</p>
<p>No interventions are included in the default settings of the model so <code>num_int = 1.</code></p>
<p>Insecticide treated nets can be added to the default model as follows. Two intervention compartments are necessary. Net usage is set to 50% in this example and is turned on 365 days into the simulation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">wh &lt;-<span class="st"> </span>hanojoel<span class="op">:::</span><span class="kw"><a href="../reference/create_r_model.html">create_r_model</a></span>(<span class="dt">odin_model_path =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="st">"extdata/odin_model.R"</span>, <span class="dt">package =</span> <span class="st">"hanojoel"</span>),
                                <span class="dt">het_brackets =</span> <span class="dv">5</span>,
                                <span class="dt">age =</span> init_age,
                                <span class="dt">init_EIR =</span> init_EIR,
                                <span class="dt">init_ft =</span> prop_treated,
                                <span class="dt">country =</span> <span class="st">"Uganda"</span>,
                                <span class="dt">admin2 =</span> <span class="st">"Tororo"</span>,
                                <span class="dt">num_int =</span> <span class="dv">2</span>,
                                <span class="dt">ITN_IRS_on =</span> <span class="dv">365</span>,
                                <span class="dt">itn_cov =</span> <span class="fl">0.5</span>)
<span class="co">#&gt; Requested: Tororo</span>
<span class="co">#&gt; Returned: Tororo, Uganda</span>

<span class="co"># generates model functions with initial state data</span>
mod &lt;-<span class="st"> </span>wh<span class="op">$</span><span class="kw">generator</span>(<span class="dt">user=</span> wh<span class="op">$</span>state, <span class="dt">use_dde =</span> <span class="ot">TRUE</span>)

<span class="co"># Runs the model</span>
mod_run &lt;-<span class="st"> </span>mod<span class="op">$</span><span class="kw">run</span>(<span class="dt">t =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">700</span>)
out &lt;-<span class="st"> </span>mod<span class="op">$</span><span class="kw">transform_variables</span>(mod_run)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(out<span class="op">$</span>t,out<span class="op">$</span>prev, <span class="dt">main=</span><span class="st">"Prevalence"</span>, <span class="dt">type=</span><span class="st">'l'</span>)</code></pre></div>
<p><img src="create_r_model_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>Indoor residual spraying (IRS) can be added to default model as follows. It requires four intervention compartments. Net usage is set to 50% in this example, IRS usage is 25% and both are turned on 365 days into the simulation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">wh &lt;-<span class="st"> </span>hanojoel<span class="op">:::</span><span class="kw"><a href="../reference/create_r_model.html">create_r_model</a></span>(<span class="dt">odin_model_path =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="st">"extdata/odin_model.R"</span>, <span class="dt">package =</span> <span class="st">"hanojoel"</span>),
                                <span class="dt">het_brackets =</span> <span class="dv">5</span>,
                                <span class="dt">age =</span> init_age,
                                <span class="dt">init_EIR =</span> init_EIR,
                                <span class="dt">init_ft =</span> prop_treated,
                                <span class="dt">country =</span> <span class="st">"Uganda"</span>,
                                <span class="dt">admin2 =</span> <span class="st">"Tororo"</span>,
                                <span class="dt">num_int =</span> <span class="dv">4</span>,
                                <span class="dt">ITN_IRS_on =</span> <span class="dv">365</span>,
                                <span class="dt">itn_cov =</span> <span class="fl">0.5</span>,
                                <span class="dt">irs_cov =</span> <span class="fl">0.25</span>)

<span class="co"># generates model functions with initial state data</span>
mod &lt;-<span class="st"> </span>wh<span class="op">$</span><span class="kw">generator</span>(<span class="dt">user=</span> wh<span class="op">$</span>state, <span class="dt">use_dde =</span> <span class="ot">TRUE</span>)

<span class="co"># Runs the model</span>
mod_run &lt;-<span class="st"> </span>mod<span class="op">$</span><span class="kw">run</span>(<span class="dt">t =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">700</span>)
out &lt;-<span class="st"> </span>mod<span class="op">$</span><span class="kw">transform_variables</span>(mod_run)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(out<span class="op">$</span>t,out<span class="op">$</span>prev, <span class="dt">main=</span><span class="st">"Prevalence"</span>, <span class="dt">type=</span><span class="st">'l'</span>)</code></pre></div>
<p><img src="create_r_model_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>Other interventions can be added in new model files specified with the <code>odin_model_path</code> variable. Any changes to the equilibrium solution should be made between the <code>hanojoel:::create_r_model()</code> and <code>wh$generator()</code> function calls and not through edits to the equilibrium solution in the model.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#default-use-of-function">Default use of function</a></li>
      <li><a href="#providing-alternative-arguments">Providing alternative arguments</a></li>
      <li><a href="#adding-additional-optional-arguments">Adding additional optional arguments</a></li>
      <li><a href="#changing-seasonality-parameters">Changing seasonality parameters</a></li>
      <li><a href="#adding-interventions">Adding interventions</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Joel Hellewell, Hannah Slater, Juliette Unwin, OJ Watson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
